## 简介

### 什么是 MyBatis？

MyBatis 是一款优秀的持久层框架，它支持自定义 SQL、存储过程以及高级映射。MyBatis 免除了几乎所有的 JDBC 代码以及设置参数和获取结果集的工作。MyBatis 可以通过简单的 XML 或注解来配置和映射原始类型、接口和 Java POJO（Plain Old Java Objects，普通老式 Java 对象）为数据库中的记录。

## 入门

### 安装

要使用 MyBatis， 只需将 mybatis-x.x.x.jar 文件置于类路径（classpath）中即可。
如果使用 Maven 来构建项目，则需将下面的依赖代码置于 pom.xml 文件中：

```xml
<dependency>
  <groupId>org.mybatis</groupId>
  <artifactId>mybatis</artifactId>
  <version>x.x.x</version>
</dependency>
```

MyBatis 的功能架构分为三层：

![](https://upload-images.jianshu.io/upload_images/1662509-46e32726788517cc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![](https://upload-images.jianshu.io/upload_images/1662509-be0223267ba1924a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## MyBatis 配置文件的 configuration 标签主要包括

* configuration 配置
* properties 属性
* settings 设置
* typeAliases 类型命名
* typeHandlers 类型处理器
* objectFactory 对象工厂
* plugins 插件
* environments 环境
* environment 环境变量
* transactionManager 事务管理器
* databaseIdProvider 数据库厂商标识
* mappers 映射器

> MyBatis 加载属性的顺序如下（引用自 [MyBatis 中文文档——properties](http://www.mybatis.org/mybatis-3/zh/configuration.html#properties)）：

1. 首先读取 properties 元素体内指定的属性
2. 然后根据 properties 元素中的 resource 属性读取类路径下属性文件或根据 url 属性指定的路径读取属性文件，并覆盖已读取的同名属性
3. 最后读取作为方法参数传递的属性，并覆盖已读取的同名属性

示例 resources/mybatis.cfg.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <!-- 为JavaBean起类别名 -->
    <typeAliases>
        <!-- 指定一个包名起别名，将包内的 Java 类的类名作为类的类别名 -->
        <package name="com.shiyanlou.mybatis.model" />
    </typeAliases>
    <!-- 配置mybatis运行环境 -->
    <environments default="development">
        <environment id="development">
            <!-- type="JDBC" 代表直接使用 JDBC 的提交和回滚设置 -->
            <transactionManager type="JDBC" />

            <!-- POOLED 表示支持JDBC数据源连接池 -->
            <!-- 数据库连接池,由 Mybatis 管理，数据库名是 mybatis，MySQL 用户名 root，密码为空 -->
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.jdbc.Driver" />
                <property name="url" value="jdbc:mysql://localhost:3306/mybatis" />
                <property name="username" value="root" />
                <property name="password" value=""/>
            </dataSource>
        </environment>
    </environments>
    <mappers>
        <!-- 通过 mapper 接口包加载整个包的映射文件 -->
        <package name="com.shiyanlou.mybatis.mapper" />
    </mappers>
</configuration>
```

## 映射文件顶级元素

映射文件是所有 SQL 语句放置的地方，写好 SQL 语句映射文件后，需要在配置文件的 mappers 标签中引用。映射文件和与它具有相同功能的 JDBC 代码相比省掉了大部分的代码，而且对 SQL 的构建比普通方法还要好，这就是 MyBatis 的强大之处。

## 映射文件包含的顶级元素

cache：给定命名空间的缓存配置。
cache-ref：其他命名空间缓存配置的引用。
resultMap：描述如何从数据库结果集中来加载对象。
sql：可被其他语句引用的可重用语句块。
insert：映射插入语句
update：映射更新语句
delete：映射删除语句
select：映射查询语句

mapper 文件示例

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shiyanlou.mybatis.mapper.UserMapper">
    <!-- 自定义返回结果集 -->
    <resultMap id="userMap" type="User">
        <id property="id" column="id" javaType="int"></id>
        <result property="username" column="username" javaType="String"></result>
        <result property="password" column="password" javaType="String"></result>
        <result property="sex" column="sex" javaType="String"></result>
        <result property="address" column="address" javaType="String"></result>
    </resultMap>

    <!-- 定义 SQL 语句，其中 id 需要和接口中的方法名一致 -->
    <!-- useGeneratedKeys：实现自动生成主键 -->
    <!-- keyProperty： 唯一标记一个属性 -->
    <!-- parameterType 指明查询时使用的参数类型，resultType 指明查询返回的结果集类型 -->
    <insert id="insertUser" useGeneratedKeys="true" keyProperty="id">
        insert into user (username,password,sex,address) values
                                                                (#{username},#{password},#{sex},#{address})
    </insert>

    <update id="updateUser"  parameterType="User">
        update user set
                        address=#{address} where
                id=#{id}
    </update>

    <delete id="deleteUser" parameterType="int">
        delete from user where
                id=#{id}
    </delete>

    <!-- 如未为 Java Bean 起类别名，resultType="com.shiyanlou.mybatis.model.User" -->

    <!-- 使用resultType时，一定要保证，你属性名与字段名相同；如果不相同，就使用resultMap -->
    <select id="selectUserById" parameterType="int" resultType="User">
        select * from user where id=#{id}
    </select>

    <select id="selectAllUser" resultMap="userMap">
        select * from user
    </select>
</mapper>
```

## spring 项目集成 mybatis 步骤

前提是提前有了数据库的表设计.

### pom 包导入

```xml
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>shiyanlou.mybatis.onetoone</groupId>
  <artifactId>OneToOne</artifactId>
  <packaging>jar</packaging>
  <version>1.0-SNAPSHOT</version>
  <name>OneToOne</name>
    <dependencies>
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.4.6</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>6.0.6</version>
        </dependency>
        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>1.2.17</version>
        </dependency>
    </dependencies>
    <build>
        <resources>
            <resource>
                <directory>src/main/java</directory>
                <includes>
                    <include>**/*.xml</include>
                </includes>
            </resource>
            <resource>
                <directory>src/main/resources</directory>
                <includes>
                    <include>**/*.*</include>
                </includes>
            </resource>
        </resources>
    </build>
</project>
```

### 实体类 和 mapper.xml 的创建

在项目目录 src/main/resources 下新建 MyBatis 配置文件 mybatis.cfg.xml ，用来配置 Mybatis 的运行环境、数据源、事务等。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <!-- 为 JavaBean 起类别名 -->
    <typeAliases>
        <!-- 指定一个包名起别名，将包内的 Java 类的类名作为类的类别名 -->
        <package name="shiyanlou.mybatis.onetoone.model" />
    </typeAliases>
       <!-- 配置 mybatis 运行环境 -->
    <environments default="development">
        <environment id="development">
           <!-- type="JDBC" 代表直接使用 JDBC 的提交和回滚设置 -->
            <transactionManager type="JDBC" />

            <!-- POOLED 表示支持 JDBC 数据源连接池 -->
            <!-- 数据库连接池，由 Mybatis 管理，数据库名是 mybatis，MySQL 用户名 root，密码为空 -->
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.jdbc.Driver" />
                <property name="url" value="jdbc:mysql://localhost:3306/mybatis" />
                <property name="username" value="root" />
                <property name="password" value="" />
            </dataSource>
        </environment>
    </environments>
    <mappers>
        <!-- 通过 mapper 接口包加载整个包的映射文件 -->
        <package name="shiyanlou.mybatis.onetoone.mapper" />
</mappers>
</configuration>
```

### 配置 log4j

使用日志文件是为了查看控制台输出的 SQL 语句。

在项目目录 `src/main/resources` 下新建 MyBatis 日志记录文件 log4j.properties ，在里面添加如下内容：

```properties
# Global logging configuration
log4j.rootLogger=DEBUG, stdout
# Console output...
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%5p [%t] - %m%n
```

### 进行测试

在包 shiyanlou.mybatis.onetoone.test 下新建测试类 Test.java ，代码如下：

```java
package shiyanlou.mybatis.onetoone.test;

import java.io.IOException;
import java.io.InputStream;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import shiyanlou.mybatis.onetoone.mapper.ClassesMapper;
import shiyanlou.mybatis.onetoone.model.Classes;

public class Test {
    private static SqlSessionFactory sqlSessionFactory;

    public static void main(String[] args) {
        // Mybatis 配置文件
        String resource = "mybatis.cfg.xml";

        // 得到配置文件流
        InputStream inputStream = null;
        try {
            inputStream = Resources.getResourceAsStream(resource);
        } catch (IOException e) {
            e.printStackTrace();
        }

        // 创建会话工厂，传入 MyBatis 的配置文件信息
        sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);

        // 通过工厂得到 SqlSession
        SqlSession session = sqlSessionFactory.openSession();

        ClassesMapper mapper = session.getMapper(ClassesMapper.class);
        try {
            Classes classes = mapper.selectClassById(1);
            session.commit();
            System.out.println(classes.getId() + "," + classes.getName() + ",["
                    + classes.getTeacher().getId() + ","
                    + classes.getTeacher().getName() + ","
                    + classes.getTeacher().getAge()+"]");

        } catch (Exception e) {
            e.printStackTrace();
            session.rollback();
        }

        // 释放资源
        session.close();

    }
}
```

6\. 运行测试

```sh
mvn compile
mvn exec:java -Dexec.mainClass="shiyanlou.mybatis.onetoone.test.Test"
```

## 参考

mybatis – MyBatis 3 | 简介
<https://mybatis.org/mybatis-3/zh/index.html>
