---
title: å‰å°æ•°æ®æ‰¹é‡å¯¼å…¥åˆ°æ•°æ®åº“
date: 2022-08-22 17:10:00
updated: 2022-08-22 17:10:00
categories:
  - è¯­è¨€-Java
  - æ¡†æ¶
---

## è¯´æ˜

### ç”¨åˆ°çš„æ¡†æ¶

RuoYi-Vue: ğŸ‰ åŸºäº SpringBootï¼ŒSpring Securityï¼ŒJWTï¼ŒVue & Element çš„å‰åç«¯åˆ†ç¦»æƒé™ç®¡ç†ç³»ç»Ÿï¼ŒåŒæ—¶æä¾›äº† Vue3 çš„ç‰ˆæœ¬
<https://gitee.com/y_project/RuoYi-Vue>

å…³é”® dependency

```xml
<!-- SpringBoot Webå®¹å™¨ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<!-- JSON å·¥å…·ç±» -->
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
</dependency>
<!-- é˜¿é‡Œ easy Excel-->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>easyexcel</artifactId>
    <version>3.1.3</version>
</dependency>
<!-- åˆ†é¡µæ’ä»¶ä¾èµ–äº† mybatis-spring-boot -->
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper-spring-boot-starter</artifactId>
</dependency>
```

<!-- more -->

## é€šè¿‡ excel è¿›è¡Œå¯¼å…¥

> æ³¨ï¼šä»¥ä¸‹å‡ä¸ºä¸ºç®€è¦è¯´æ˜ï¼Œå®Œæ•´ç¤ºä¾‹è¯·è·å–å®Œæ•´ä»£ç ã€‚

com.ruoyi.prevention.controller.PopulationController.java

```java
@PostMapping("/importData")
public R<String> importData(@RequestParam(value="file") MultipartFile file) throws Exception {
    if (file == null) {
        logger.info("file is null");
    }
    final PopulationExcelReadListener readListener = new PopulationExcelReadListener(populationMapper);
    EasyExcel.read(file.getInputStream(), DailyNucleicInputExcel.class, readListener).doReadAll();
    return R.ok("å·²å¯¼å…¥" + readListener.getEffectRows() + "æ¡è®°å½•");
}
```

com.ruoyi.prevention.utils.PopulationExcelReadListener è¿›è¡Œæ•°æ®çš„æ ¡éªŒå’Œè·å–æ•°æ®å¹¶å…¥åº“

```java
public class PopulationExcelReadListener implements ReadListener<DailyNucleicInputExcel> {

    /**
     * æ¯éš” 500 æ¡å­˜å‚¨æ•°æ®åº“ï¼Œç„¶åæ¸…ç† listï¼Œæ–¹ä¾¿å†…å­˜å›æ”¶
     */
    private static final int BATCH_COUNT = 500;
    /**
     * å¸¸ä½äººå£
     */
    private final List<PopulationDO> cachedResidentDataList = new ArrayList<>(BATCH_COUNT);

    /**
     * å‡è®¾è¿™ä¸ªæ˜¯ä¸€ä¸ª DAOï¼Œå½“ç„¶æœ‰ä¸šåŠ¡é€»è¾‘è¿™ä¸ªä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª serviceã€‚å½“ç„¶å¦‚æœä¸ç”¨å­˜å‚¨è¿™ä¸ªå¯¹è±¡æ²¡ç”¨ã€‚
     */
    private final PopulationMapper mapper;

    /**
     * å¦‚æœä½¿ç”¨äº† spring,è¯·ä½¿ç”¨è¿™ä¸ªæ„é€ æ–¹æ³•ã€‚æ¯æ¬¡åˆ›å»ºListenerçš„æ—¶å€™éœ€è¦æŠŠspringç®¡ç†çš„ç±»ä¼ è¿›æ¥
     *
     * @param mapper
     */
    public PopulationExcelReadListener(PopulationMapper mapper) {
        this.mapper = mapper;
    }

    @Override
    public void invoke(DailyNucleicInputExcel excelData, AnalysisContext context) {
        // æ•°æ®æ ¡éªŒ + è¿‡æ»¤æ¡ä»¶
        // æ‹¿åˆ°å•ä¸ªå¯¹è±¡å¹¶åŠ å…¥ list
        // åˆ¤æ–­å¦‚æœ list å·²æ»¡åˆ™æ‰¹é‡æ’å…¥
    }

    @Override
    public void doAfterAllAnalysed(AnalysisContext context) {
        // è¿™é‡Œä¹Ÿè¦ä¿å­˜æ•°æ®ï¼Œç¡®ä¿æœ€åé—ç•™çš„æ•°æ®ä¹Ÿå­˜å‚¨åˆ°æ•°æ®åº“
    }
}
```

com.ruoyi.prevention.mapper.PopulationMapper æ¥å£å£°æ˜

```java
/**
    * æ‰¹é‡æ’å…¥å¸¸ä½äººå‘˜
    *
    * @param list è®¾å¤‡
    * @return ç»“æœ
    */
long insertResidentBatch(List<PopulationDO> list);
```

src\main\resources\mapper\prevention\PopulationMapper.xml

è¿™é‡Œé€‰æ‹© foreach æ‰¹é‡æ’å…¥æ•ˆç‡é«˜ã€‚ç›®å‰ä»æ¥å£æµ‹è¯• 50 ä¸‡æ¡æ•°æ®è€—æ—¶ 100 ç§’ä¸Šä¸‹ã€‚å¦å¤–å¯æŒ‰å®é™…éœ€è¦æ˜¯å¦æ­é… ON DUPLICATE KEY UPDATE è¿›è¡Œè¦†ç›–æ’å…¥ã€‚å¦å¤–è¯·æ ¹æ®éœ€è¦æ˜¯å¦è¦å¯ç”¨å¤šçº¿ç¨‹è¿›è¡Œæ’å…¥ã€‚

```xml
 <!-- æ‰¹é‡æ’å…¥-->
<insert id="insertResidentBatch" parameterType="java.util.List">
    INSERT IGNORE INTO population
    (card_number, name, tel, district
    , town, community, addr, detail_addr, update_time
    ) VALUES
    <foreach collection="list" item="it" separator=",">
        (
        #{it.cardNumber}, #{it.name}, #{it.tel}, #{it.district}
        , #{it.town}, #{it.community}, #{it.addr}, #{it.detailAddr}, #{it.updateTime}
        )
    </foreach>
    ON DUPLICATE KEY UPDATE

    name = values(name),
    tel = values(tel),
    district = values(district),

    town = values(town),
    community = values(community),
    addr = values(addr),
    detail_addr = values(detail_addr),
    update_time = values(update_time)
</insert>
```

## é€šè¿‡ json è¿›è¡Œå¯¼å…¥

com.ruoyi.prevention.controller.PopulationController.java

å’Œé€šè¿‡ excel è¿›è¡Œç±»å‹ï¼Œç›´æ¥å°†å‰ç«¯ä¼ å…¥çš„ json æ•°æ®è¿›è¡Œæ ¡éªŒå»é‡è¿‡æ»¤ç­‰æ“ä½œåç›´æ¥å­˜å…¥æ•°æ®åº“ã€‚

```java
@PostMapping("/importDataByJson")
public R<String> insertBatch(@RequestBody final DailyNucleicInputExcel[] array) {
    logger.info("importDataByJson ---: å¯¼å…¥ json äººå‘˜ä¿¡æ¯æ¡ç›®æ•° = {}", array.length);
    final Date timeStampDate = new Date();
    // å§“åä¸ä¸ºç©º ä¸” ä¸åŒ…å«æœåŠ¡åŒº ä¸” èº«ä»½è¯å»é‡
    final List<PopulationDO> dailyNucleicDOList = Arrays.stream(array)
            .filter(DailyNucleicInputExcel::nameIsNotNull)
            .filter(DailyNucleicInputExcel::cardNumberIsValid)
            .filter(DailyNucleicInputExcel::notContainsServiceArea)
            .distinct()
            .map(it -> PopulationFactory.newInstance(it, timeStampDate))
            .collect(Collectors.toList());
    final long effectRows = this.populationService.insertResidentBatch(dailyNucleicDOList);
    return R.ok("å·²å¯¼å…¥" + array.length + "æ¡è®°å½•");
}
```

com.ruoyi.prevention.service.PopulationService

```java
public long insertResidentBatch(List<PopulationDO> populationDOList) {
    final int size = populationDOList.size();
    final int batchSize = 500;
    int used = 0;
    long inserts = 0;
    while (used < size) {
        int step = Math.min(size - used, batchSize);
        long before = System.currentTimeMillis();
        inserts += this.populationMapper.insertResidentBatch(populationDOList.subList(used, used + step));
        this.logger.debug("æ’å…¥è€—æ—¶ï¼š" + (System.currentTimeMillis() - before) + "æ¯«ç§’");
        used += step;
    }
    return inserts;
}
```

## å¯¼å‡ºäººå‘˜ä¿¡æ¯åˆ° excel

```java
@PostMapping("/export")
public void export(HttpServletResponse response, @RequestBody PopulationListInputVO inputVO)
        throws UnsupportedEncodingException {
    // ä»æ•°æ®åº“æ¡ä»¶æŸ¥è¯¢è¦å¯¼å‡ºçš„æ•°æ®åè¿›è¡Œå¯¼å‡ºå³å¯ ...
    final EasyExcelUtil<PopulationOutputVO> easyExcelUtil = new EasyExcelUtil<>(PopulationOutputVO.class);
    easyExcelUtil.exportEasyExcel(response, populationQueryList, this.sheetName);
}
```
