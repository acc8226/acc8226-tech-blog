# 设备模拟器快速接入【零代码零硬件玩转华为云IoT】

近期听说华为云IoT物联网平台（IoTDA设备接入云服务）提供海量设备的接入和管理能力，将物理设备联接到云，支撑设备数据采集上云和云端下发命令给设备进行远程控制，配合华为云其他产品，可快速构筑物联网解决方案。

且初期无任何消费，于是乎本次我体验了一番。

## 开通服务

首选需要注册华为云官方帐号并进行实名认证，然后点击[华为云物联网平台_华为云IoT平台](https://www.huaweicloud.com/product/iothub.html)开通服务即可。

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237451386760504.png)

接着点击免费试用。这里我开通了一个月的免费套餐。

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237473184997212.png)

开通成功后稍等片刻，即可进入主页面。

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237496697304237.png)

## 创建产品

在物联网平台中，某一类具有相同能力或特征的设备的合集被称为一款产品。接下来我们登录管理控制台，单击左侧导航栏“产品”，单击页面左侧的“创建产品”。

1. 填写产品名称：设备接入体验-产品
2. 协议类型： mqtt
3. 数据格式： json
4. 设备类型： 自定义
5. 设备类型：设备接入体验-设备

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237509126714191.png)

系统提示产品创建成功，并生成了产品 ID。

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237524063994994.png)

由于我希望使用平台查看设备上报的数据信息，以及可能之后需要设备进行管理控制，这里还需要设置产品模型(Profile)。

点击产品名称。

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237537995244733.png)

切换到模型定义选项卡，点击自定义模型，添加服务。在服务 ID 中填入 serviceA，点击确定。

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237547870186879.jpg)

新增一个属性：温度

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237556637365776.png)

## 注册设备

点击左侧的所有设备，填写注册信息如下图。

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237567199974835.png)

成功注册设备后，平台会自动生成设备 ID 和密钥。这里记录设备ID（deviceId）660e9e592a631a0c8fb10c6c_deviceA1 和密钥（deviceSecret），设备接入中要用到。

## 使用模拟器接入

直接使用我手头 mac 之前已安装的 [MQTTX：MQTT 客户端工具](https://mqttx.app/zh) 进行连接。

首先从设备列表中进入设备的详情页，查看设备的 MQTT 连接参数并填入 mqttx 的新建连接配置选项。

注：如果您选择安全方式接入，Broker Port 需要设置为 8883 和 mqtts 搭配，而非 1883 端口。

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237577670987676.png)

配置完连接参数后，在 mqttx 中点击连接按钮。一旦设备接入物联网平台，平台可以看到该设备的在线状态。

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237586493262649.png)

## 设备上报数据

已知上行 Topic 格式为 $oc/devices/{device_id}/sys/properties/report

这里我们将 {device_id} 换成成真实的设备 ID，因此最终为：`Topic: $oc/devices/660e9e592a631a0c8fb10c6c_deviceA1/sys/properties/report`

上行报文为：

```json
{
    "services": [{
            "service_id": "serviceA",
            "properties": {
                "温度": 32.3
            }
        }
    ]
}
```

其中 service_id 必选，为设备的服务 ID，由创建的产品模型确定。
properties 表示设备服务的属性列表，具体字段在设备关联的产品模型中定义，可以设置多个字段。这里只使用了上面定义产品模型中的 ”温度“ 字段。

在 mqttx 中填写好上行 topic 和 数据后点击按下 alt + enter 快捷键或者直接点击图标进行发送。

![](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237646745855315.png)

在网页控制台可以看到数据更新。

![图 13](https://bbs-img.huaweicloud.com/blogs/img/20240404/1712237668542113635.png)

## 设备命令下发

目前平台提示 MQTT 协议设备仅支持同步命令下发。我们需要先在管理控制台下发命令，已达到远程控制设备的目的。

根据平台介绍的上下行 topic:

* 下行： $oc/devices/{device_id}/sys/commands/request_id={request_id}
* 上行：$oc/devices/{device_id}/sys/commands/response/request_id={request_id}

其中 {request_id} 用于唯一标识这次请求。设备侧收到下行请求的 topic 带该参数时，上行响应的 topic 需要将该参数值返回给平台。

这里我们将 {device_id} 换成成真实的设备 ID，由于 {request_id} 不能提前预知，我们使用了井号通配符，最终为：`$oc/devices/660e9e592a631a0c8fb10c6c_deviceA1/sys/commands/#`

在订阅后，我们即可进入网页设备控制台。选择“设备 > 所有设备”，找到新建的设备，单击“详情”进入设备详情页面。单击“云端下发”页签，下发同步命令。

注：设备所属的产品模型需要预先定义新增命令后才能下发。

一旦设备收到订阅，设备需要及时响应。命令应答的 json 格式，具体字段在设备关联的产品模型中定义。

1. result_code 可选 Integer 标识命令的执行结果，0表示成功，其他表示设备执行结果为失败。不带默认为0。
2. response_name 可选 String 命令的响应名称。
3. paras 可选 Object 命令的响应参数，具体字段在设备关联的产品模型中定义。

上行响应示例如下：

```json
// 注意：上行填写的 {request_id} 需要与下行的一致
Topic：$oc/devices/660e9e592a631a0c8fb10c6c_deviceA1/sys/commands/response/request_id={request_id}

{
    "result_code": 0,
    "response_name": "COMMAND_RESPONSE",
    "paras": {
        "result": "success"
    }
}
```

## 结束

至此，本次实验完美结束。

我正在参加【有奖征文 第29期】零代码零硬件玩转华为云 IoT 物联网平台多场景
链接：https://bbs.huaweicloud.com/blogs/423245

# 体验云端设置恒温空调【零代码零硬件玩转华为云IoT】

## 场景说明

近期听说华为云 IoT 物联网平台（IoTDA 设备接入云服务）提供海量设备的接入和管理能力，将物理设备联接到云，支撑设备数据采集上云和云端下发命令给设备进行远程控制，配合华为云其他产品，可快速构筑物联网解决方案。

华为云 IoT 物联网平台支持创建设备的“影子”。设备影子比较适合资源受限低功耗设备，长期处于休眠状态的场景。

* 查询设备最新上报数据和设备最新在线状态：
  * 当在控制台上查询设备上报数据时，由于设备可能长时间处于离线状态或因网络不稳定掉线，而无法获取到最新数据。通过设备影子机制，设备影子中始终保持设备最新上报的数据和设备当前状态，控制台上只需要查询设备影子中存储的数据，即可获取设备最新上报的数据和设备状态。
  * 很多应用服务器频繁的查询设备在线状态，由于设备处理能力有限，频繁查询会损耗设备性能。使用设备影子机制，设备只需要主动同步状态给设备影子一次，多个应用程序请求设备影子获取设备状态，即可获取设备最新状态，从而将应用程序和设备解耦。
* 由于设备可能长时间处于离线状态，修改设备属性值的操作不能及时下发给设备。在这种情况下，物联网平台可以将修改设备的属性信息存储在设备影子中，待设备上线后，将修改的设备属性值同步给设备，从而完成设备属性值的修改。

比如在一些恒温控制系统中，不论空调是否开机，都可以调整空调默认温度，待空调上电开机后，自动按默认温度调节。空调接入到物联网平台后，用户可以在应用侧或者设备接入控制台设置设备影子，将预置的温度通过设备影子下达属性修改给空调。空调收到修改属性的要求后，自动调节温度。

本期我将继续演示通过华为云 IoT，模拟体验云端设置恒温空调。

## 前提

需要使用已有设备，如果暂时没有设备需要先行创建产品 + 注册设备。

可参考我之前发布在华为云社区的文章[《设备模拟器快速接入【零代码零硬件玩转华为云IoT】-云社区-华为云》](https://bbs.huaweicloud.com/blogs/425073)。

本节我将继续使用上一节的设备 deviceA1 进行实验。该设备目前只有一个 “温度” 的属性，数值类型为小数。

## 配置设备影子

恒温空调案例其实是设备侧获取平台的设备影子数据的一个应用。

一般而言设备向平台获取设备影子数据。用户可以通过应用服务器或物联网控制台配置设备影子预期数据，设备上线时订阅该topic，可以获取到平台设备影子数据，以此来同步设备属性期望值，从而完成设备属性值的修改。

登录控制台，选择左侧导航栏的“设备”，接着进入到恒温空调设备的详情页面。选择“设备影子”页签，单击“属性配置”。

![图 1](https://bbs-img.huaweicloud.com/blogs/img/20240405/1712301869581833947.png)

在弹出窗口中输入服务属性对应的期望值。此处设置“温度”的属性值为 55.2。

![图 2 配置设备影子](https://bbs-img.huaweicloud.com/blogs/img/20240405/1712301901714659360.png)

## 验证操作

您可以使用配置设备接入服务时注册的真实设备接入平台，设备会收到平台下发的设备影子，修改空调的预设温度值。但是我没有真实设备，所以使用 MQTTx 模拟设备。

已知设备订阅设备影子的下行 topic 为 `$oc/devices/{device_id}/sys/shadow/get/response/#`，其中  {device_id} 需要填写正确的设备 ID。举例：`$oc/devices/660e9e592a631a0c8fb10c6c_deviceA1/sys/shadow/get/response/#`

一旦订阅成功，我们为了模拟设备上线，往设备影子的上行 Topic `$oc/devices/{device_id}/sys/shadow/get/request_id={request_id}` 发送请求。其中 {request_id} 用于唯一标识这次请求。设备侧发起的消息带该参数时，需要保证设备侧该参数值的唯一性，可以用递增的数字或者 UUID 来实现。举例：`$oc/devices/660e9e592a631a0c8fb10c6c_deviceA1/sys/shadow/get/request_id=1`

这里我填写为空，所以查询所有服务 ID 的设备影子数据。

上行请求示例

```json
{}
```

在 mqttx 的订阅页面即可查看平台返回的数据，包括了 desired 和 reported 值。

![图 3](https://bbs-img.huaweicloud.com/blogs/img/20240405/1712301888129558236.png)

为方便大家查看，我特意贴出返回 json 结果。

```json
{
    "shadow": [
        {
            "desired": {
                "properties": {
                    "温度": 55.2
                },
                "event_time": "20240404T142949Z"
            },
            "reported": {
                "properties": {
                    "温度": 32.3
                },
                "event_time": "20240404T132320Z"
            },
            "version": 7,
            "service_id": "serviceA"
        }
    ],
    "object_device_id": "660e9e592a631a0c8fb10c6c_deviceA1"
}
```

至此，本次实验完美结束。

我正在参加【有奖征文 第29期】零代码零硬件玩转华为云 IoT 物联网平台多场景
链接：https://bbs.huaweicloud.com/blogs/423245

- - -

# 监控设备状态以及发送通知【零代码零硬件玩转华为云IoT】

## 场景说明

在物联网场景下，部分设备具备重要的应用场景，比如物联网网关等，设备管理者需要感知这些设备的上下线情况。华为云IoT设备接入服务提供的规则引擎功能可以通过简单的操作，实现当设备状态满足某个条件时，物联网平台触发指定动作进行通知。

比如某企业的网关产品下有一批网关设备，单个网关设备下挂载了约 400 个子设备，用户需要实时关注这批网关设备的状态，确保子设备正常上报数据，同时由于网关设备和物联网平台通过 4G 网络建立连接，存在由于网络抖动导致频繁告警的问题，因此用户认为短暂的离线后上线属于正常场景，不希望感知这种场景。

本次我将演示通过华为云IoT，用于监控某类特定产品下特定设备，当设备在离线持续时间达到5分钟后通过物联网平台上报告警，在设备上线持续时间达到1分钟后恢复该告警，同时发送邮件或短信通知给指定的手机号码。

## 前提

需要使用已有设备，如果暂时没有设备需要先行创建产品 + 注册设备。

可参考我之前发布在华为云社区的文章[《设备模拟器快速接入【零代码零硬件玩转华为云IoT】-云社区-华为云》](https://bbs.huaweicloud.com/blogs/425073)。

本节我将继续使用上一节的设备 deviceA1 进行实验。该设备目前只有一个 “温度” 的属性，数值类型为小数。

## 配置设备接入服务

选择左侧导航栏的“规则>设备联动”，单击右上角的“创建规则”按钮。（创建规则前需选择所属资源空间）

图 1

分别新建设备下线监控 和 设备上线监控。

图 2

图 3

## 配置消息通知服务

创建短信或邮件订阅。

在消息通知服务中创建主题

1. 登录华为云官方网站，[访问消息通知服务](https://www.huaweicloud.com/product/smn.html)。 
2. 单击“立即使用”进入消息通知服务控制台。若您未开通消息通知服务，请先开通服务。
3. 进入“主题管理 > 主题”页面，单击“创建主题”。
4. 输入主题名称，如“Test_1”，单击“确定”。

图 4

添加订阅，调用以发送邮件或短信。

1. 进入“主题管理 > 订阅”页面，单击“添加订阅”。
2. 填写订阅信息。填写完成后单击“确定”。

图 5

这里我只选择了邮箱协议。

注意：订阅短信或者邮箱后都需要验证订阅，点击系统发送过来的链接即可完成订阅主题。

## 配置应用运维管理服务

在[应用运维管理 AOM](https://www.huaweicloud.com/product/aom.html)中创建告警规则和告警行动规则，当设备接入服务满足条件上报告警后，对上报告警进行处理并发送邮件或短信。

1. 登录华为云官方网站，访问应用运维管理服务。
2. 单击“立即使用”进入应用运维管理服务控制台。若您未开通应用运维管理服务，请先开通服务。
3. 进入“告警 > 告警行动规则”页面，单击“创建告警行动规则”。
4. 输入告警行动规则名称，如“Test_1”，主题选择配置消息通知服务中创建的主题“Test_1”，单击“确定”。

图 6

进入“告警 > 告警规则”页面，单击“添加告警”。

输入规则名称，如“Gateway_Status_Change_Alarm_Rule”，选择“事件告警规则 > 自定义事件”，告警来源选择“IoTDA”，监控对象选择自定义属性“event_name=网关状态变更”（“=”后面内容为告警名称），触发策略选择“立即触发”，告警方式选择直接告警，行动规则选择上一步创建的行动规则，单击右下角“立即创建”。

图 7

## 验证操作

使用模拟器模拟设备上下线。

设备离线持续时长达到5分钟后， 从左侧导航栏选择“监控运维 > 当前告警”，单击“前往AOM”，跳转至应用运维管理服务，有一条名称为“网关状态变更”的重要告警。

图 8

同时已订阅的邮件也收到通知。

图 9

当设备上线持续时长达到 1 分钟后，由于我在应用运维管理服务配置了告警规则和邮件通知告警行动规则，订阅的邮箱会收到一封设备离线恢复的邮件。

图 10 缺少图

我正在参加【有奖征文 第29期】零代码零硬件玩转华为云 IoT 物联网平台多场景
链接：https://bbs.huaweicloud.com/blogs/423245
