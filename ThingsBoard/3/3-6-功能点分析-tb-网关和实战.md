## ThingsBoard 网关

![](https://upload-images.jianshu.io/upload_images/1662509-6eedd73de54a17e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

为了将您的物联网网关连接到 ThingsBoard 服务器，您需要首先提供网关凭据。我们将使用访问令牌凭证作为最简单的凭证。有关详细信息，请参阅设备身份验证选项。

以租户管理员身份登录。在使用本地 ThingsBoard 服务器时使用默认凭据。打开设备，然后点击右上角的“ +”按钮。

## 网关架构

对平台来说网关是一个设备：只不过网关的消息体和其他设备不一样，网关监听的是消息代理发送的消息。针对 MQTT 来说，网关只不过选择性监听了 topic，构建了一个映射 “map” 关系。

![](https://upload-images.jianshu.io/upload_images/1662509-831698158af98bbc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

网关详情：https://thingsboard.io/docs/iot-gateway/what-is-iot-gateway/

## 网关安装

The IoT Gateway 是一个基于 Linux 的支持 **Python 3.7+** 的微计上运行的软件组件。物联网网关的主要组件如下。

### 通过源代码方式安装

从源代码安装 ThingsBoard 网关您应遵循以下步骤：

**1\. 使用 apt 将所需的库安装到系统中：**

```
sudo apt install python3-dev python3-pip libglib2.0-dev git 
```


**2\. 从 Github 克隆源代码：**

```
git clone https://github.com/thingsboard/thingsboard-gateway.git
```

**3\. 进入代码目录：**

```
cd thingsboard-gateway
```

**4\. 使用 setup.py 脚本安装 python 模块：**

```
python3 setup.py install
```

**5\. 创建“日志”文件夹：**

```
mkdir logs
```

**6\. 将网关配置为与您的 ThingsBoard 平台实例一起使用**

**7\. 运行网关，检查安装结果：**

```
python3 ./thingsboard_gateway/tb_gateway.py
```

---
期间遇到问题：运行报错 AttributeError: module 'google.protobuf.descriptor' has no attribute '_internal_create_key'

解决方案：try the next command `pip install --upgrade protobuf`

### pip 方式安装网关

将 ThingsBoard 网关安装为 python 模块，您应该遵循以下步骤：

**1\. 使用apt将所需的库安装到系统中**

```
sudo apt install python3-dev python3-pip libglib2.0-dev 
```

**2\. 使用 pip 安装ThingsBoard网关模块：**

```
sudo pip3 install thingsboard-gateway
```

**3\. 下载配置示例，创建日志文件夹：**

* 下载配置示例：

```
wget https://github.com/thingsboard/thingsboard-gateway/releases/download/2.0/configs.tar.gz
```

* 创建配置目录：

```sh
sudo mkdir /etc/thingsboard-gateway
```

* 创建日志目录：

```sh
sudo mkdir /var/log/thingsboard-gateway
```

*解压配置：
```
sudo tar -xvzf configs.tar.gz -C /etc/thingsboard-gateway
```

**4\. 使用命令检查安装**（由于没有配置网关因此会出现连接错误*有关配置请使用[配置指南](http://www.ithingsboard.com/docs/iot-gateway/configuration-guide))：*

```
thingsboard-gateway
```

## 网关配置

划分数据文件，日志文件。拓展支持文件。

## 实战

安装完成后，需要配置网关信息

![](https://upload-images.jianshu.io/upload_images/1662509-0ce283af8f7f2757.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

下载运行 thingsboard-gateway
我是在虚拟机环境通过 docker 安装的

```sh
docker run -it -v ~/.tb-gateway/logs:/thingsboard_gateway/logs -v ~/.tb-gateway/extensions:/thingsboard_gateway/extensions -v ~/.tb-gateway/config:/thingsboard_gateway
```

配置 tb_gateway.yml

```yml
thingsboard:
  host: 192.168.137.131
  port: 1883
  remoteShell: false
  remoteConfiguration: false
  security:
    accessToken: VO9ZKbJAIW9QK8IZbPhq
  qos: 1
storage:
  type: memory
  read_records_count: 100
  max_records_count: 100000
#  type: file
#  data_folder_path: ./data/
#  max_file_count: 10
#  max_read_records_count: 10
#  max_records_per_file: 10000
connectors:
  -
    name: MQTT Broker Connector
    type: mqtt
    configuration: mqtt.json
```

host 是thingsboard的ip地址，这里我设置的是我另外一个虚拟机的 IP
port就是 thingsboard的 MQTT 的 port 端口
accessToken 是网关的口令。

![](https://upload-images.jianshu.io/upload_images/1662509-63d20175e414ff87.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

因为这里只有一个mqtt设备，所以connectors只有一个

下一步配置 mqtt 远程信息，但是需要安装 mqtt broker，这里我选择使用 hivemq

安装hivemq
使用 docker 进行部署

然后登录 进 hivemq 的web控制台

![](https://upload-images.jianshu.io/upload_images/1662509-1d677d3cf1f6d7c2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

记录好 hivemq 的ip地址

配置 gateway 中的 mqtt.json

```json
{
  "broker": {
    "name":"Default Local Broker",
    "host":"192.168.137.129",
    "port":1883,
    "clientId": "ThingsBoard_gateway",
    "security": {
      "type": "basic",
      "username": "admin",
      "password": "hivemq"
    }
  },
  "mapping": [
    {
      "topicFilter": "/sensor/data",
      "converter": {
        "type": "json",
        "deviceNameJsonExpression": "${serialNumber}",
        "deviceTypeJsonExpression": "${sensorType}",
        "timeout": 60000,
        "attributes": [
          {
            "type": "string",
            "key": "model",
            "value": "${sensorModel}"
          },
          {
            "type": "string",
            "key": "${sensorModel}",
            "value": "on"
          }
        ],
        "timeseries": [
          {
            "type": "double",
            "key": "temperature",
            "value": "${temp}"
          },
          {
            "type": "double",
            "key": "humidity",
```

这里面最主要的是 broker 这段

```json
 "broker": {
    "name":"Default Local Broker",
    "host":"192.168.137.129",
    "port":1883,
    "clientId": "ThingsBoard_gateway",
    "security": {
      "type": "basic",
      "username": "admin",
      "password": "hivemq"
    }
```

host 就是 hivemq的ip 地址
port 是hivemq的port 端口
security 是默认的安全配置，官网推荐的是 basic

使用mqttbox连接hivemq

![](https://upload-images.jianshu.io/upload_images/1662509-42112e8fb1e6e8e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

这里的IP地址是hivemq的地址，不要写成thingsboard或者gateway的地址
点击save查看连接状态

![](https://upload-images.jianshu.io/upload_images/1662509-69f7332e5034e5f1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

hivemq控制台也能看到这个客户端的连接信息

![](https://upload-images.jianshu.io/upload_images/1662509-85173b8c7c0c60d2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

发送设备信息到 hivemq

通过 mqtt.json 中设置的信息规则，发送信息

![](https://upload-images.jianshu.io/upload_images/1662509-2dcf5d972f46ad66.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

这里一定要注意发送的Payload中的双引号一定要用英文的。

查看 thingsboard 控制台信息

可以看到我们通过网关将我们配置的设备信息已经显示到 thingsboard 中去了

## 模拟实现具体应用场景

## 故障排除

ThingsBoard 日志存储在以下目录中:
**/var/log/thingsboard**

你可以发出以下命令以检查后端是否有任何错误:
**cat /var/log/thingsboard/thingsboard.log | grep ERROR**
