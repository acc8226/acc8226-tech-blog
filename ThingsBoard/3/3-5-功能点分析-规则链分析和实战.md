## Thingsboard 规则引擎

规则引擎解释：“规则引擎由推理引擎发展而来，是一种嵌入在应用程序中的组件，实现了将业务决策从应用程序代码中分离出来，并使用预定义的语义模块编写业务决策。接受数据输入，解释业务规则，并根据业务规则做出业务决策。”  [Thingsboard](https://www.iotschool.com/topic/26.html)解释：[Thingsboard](https://www.iotschool.com/topic/26.html)平台的核心处理引擎，好比一台车子的发动机，是基于事件构建的工作流，是一个高度可定制的框架，用于复杂事件的处理。  

规则链是规则节点及其关系的逻辑组。接收来自节点的出站消息将其发送至下一个节点。  用法：租户管理员可以定义一个“ 根”规则链，还可以定义多个其他规则链。根规则链处理所有传入的消息，并将其转发到其他规则链以进行其他处理。其他规则链也可以将消息转发到不同的规则链。

tb 的 Rule Engine 是一个易于使用的框架，用于构建基于事件的工作流。有 3 个主要组成部分：

**1. 消息**

任何传入的事件。它可以是来自设备的传入数据，设备生命周期事件，REST API 事件，RPC请求等。

**2. 规则节点**

在传入消息上执行的功能。有许多不同的 Node 类型可以对传入的Message进行过滤，转换或执行某些操作。

**3. 规则链**

节点通过关系相互连接，因此来自规则节点的出站消息被发送到下一个连接的规则节点。

![](https://upload-images.jianshu.io/upload_images/1662509-d39500c6619f7a8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

规则引擎详情说明： https：//thingsboard.io/docs/user-guide/rule-engine-2-0/re-getting-started/

## tb 规则链可实现功能

* 在保存到数据库之前，对传入遥测或属性进行数据验证和修改。
* 将遥测或属性从设备复制到相关资产，以便可以汇总遥测。例如，可以将多个设备中的数据汇总到相关资产中。
* 根据定义的条件创建/更新/清除警报。
* 根据设备生命周期事件触发操作。例如，如果设备处于在线/离线状态，则创建警报。
* 加载处理所需的其他数据。例如，在“设备的客户”或“租户”属性中定义的设备的负载温度阈值。
* 触发对外部系统的 REST API 调用。
* 发生复杂事件时发送电子邮件，并使用“电子邮件模板”中其他实体的属性。
* 在事件处理期间要考虑用户的偏好。
* 根据定义的条件进行RPC调用。
* 与外部管道（如 Kafka，Spark，AWS 服务等）集成。

### [Thingsboard](https://www.iotschool.com/topic/26.html)规则引擎能力是什么？

1、在[设备](https://www.iotschool.com/)数据（实时数据/属性数据）保存到数据库之前，支持对接收的遥测数据或属性数据进行拦截验证和修改；  
2、将[设备](https://www.iotschool.com/)遥测数据（实时数据）或者[设备](https://www.iotschool.com/)属性从[设备](https://www.iotschool.com/)复制到相关资产，以便可以汇总遥测；  
3、自定义告警规则/函数，进行[设备](https://www.iotschool.com/)告警触发、更新、清除； 
4、根据[设备](https://www.iotschool.com/)生命周期事件触发操作。如[设备](https://www.iotschool.com/)上线、[设备](https://www.iotschool.com/)离线状态，创建告警事件；  
5、加载所需的其他处理数据。在客户[设备](https://www.iotschool.com/)或租户属性中定义的[设备](https://www.iotschool.com/)的负载温度阈值；  
7、发生复杂事件时发送电子邮件，并使用“电子邮件模板”中其他实体的属性；  
8、根据定义的条件进行远程[设备](https://www.iotschool.com/)控制的RPC调用。  
9、将[设备](https://www.iotschool.com/)实时数据、远程控制RPC指令，或者由规则引擎触发的告警或者事件，推送到与外部消息中间件或者第三方系统（如Kafka，MQTT，RabbitMQ, Spark，AWS服务等等）  简单的总结：能够用于接收任何事件，可以是来自[设备](https://www.iotschool.com/)的，[设备](https://www.iotschool.com/)生命周期事件、REST API事件、RPC请求等的传入；能够处理单个传入消息并生成一个或多个传出消息，发往不同的规则链路进行消息的路由处理，同时可以过滤，丰富，转换传入消息，执行操作或与外部系统通信。

### **三、规则引擎的组成有哪几部分？**

1.规则消息（Message）

作用：用于接收任何事件，可以是来自[设备](https://www.iotschool.com/)的，[设备](https://www.iotschool.com/)生命周期事件、REST API事件、RPC请求等的传入  特点：可以被序列化的有着规定的数据结构，表示系统中的各种消息  消息组成：消息ID(MessageId)，基于时间的通用唯一标识符；消息发起者（Originator of the Message)，Device,Asset或者其他Entity标识符；消息类型（Type Of the Message），遥测或者不活动的事件；消息负载（Payload of the message），带有实际消息有效负载的json报文；元数据（Metadata），键值对的列表以及消息有关的其他数据。  

2.规则节点（Rule Node）

是什么？规则节点是规则引擎的基本组件，它一次处理单个传入消息并生成一个或多个传出消息。规则节点是规则引擎的主要逻辑单元。规则节点可以过滤，丰富，转换传入消息，执行操作或与外部系统通信。  作用：规则节点可以过滤，丰富，转换传入消息，执行操作或与外部系统通信。提供节点自定义能力，实现数据的运算。  节点间的关系：规则节点可能与其他规则节点相关。每个关系都有关系类型，这是用于标识关系的逻辑含义的标签。当规则节点生成传出消息时，它总是指定用于将消息路由到下一个节点的关系类型。  规则节点类型：  

a、过滤节点（用于消息过滤和路由，过滤成功走真链、错误走假链）。示例1：script（脚本过滤器节点）使用javascript条件进行消息过滤（消息msg，metadata消息元数据，msgType消息类型）；示例2：switch（交换节点）将传入消息路由到一个或多个输出链，节点执行已配置的JavaScript函数。  

b、属性集节点：用于更新传入消息的元数据。比如1：消息发起方用户属性（customer attributes），将消息发起方属性信息或者遥测数据加入Metadata元数据中。比如2：[设备](https://www.iotschool.com/)属性（device attributes），将消息发起方的[设备](https://www.iotschool.com/)属性或者遥测数据加入metadata。  属性集节点：  [图片上传失败...(image-2e2c77-1650095256196)]

c、变换节点：用户更改创立的消息字段，比如，发起方、类型、有效负载，元数据。比如1：脚本转换节点（script），作用：修改消息内容（msg（消息负载）,msgType（消息类型）,metadata（元数据））,可增加，可改。比如2：转换到电子邮件节点（to email），通过使用从消息元数据派生的值填充电子邮件字段，将消息转换为电子邮件消息。设置“ SEND_EMAIL”输出消息类型，以后可以被“ 发送电子邮件节点”接受。可以将所有电子邮件字段配置为使用元数据中的值。  [图片上传失败...(image-7ec834-1650095256196)]

d、动作节点：根据传入的消息执行各种动作。比如1：create alarm（创建告警），通过过滤节点中的过滤脚本判断后，对满足条件的消息进行告警的触发。比如2：log（创建日志），对于系统中的关键系统进行日志输出，比如3：rpc call request（远程RPC调用），监控系统rpc请求，下发控制命令请求。  

e、外部节点：提供将消息及数据路由到外部中间件，或者其他第三方云平台中。用于与外部系统进行交互。实例1：kafka(kafka消息中间件)，MQTT(外部MQTT代理)，RabbitMQ,支持将系统中的数据发布到kafka/MQTT代理/RabbitMQ中，供第三方消费者订阅数据。实例2：send email （向外部发送邮件）。实例3：aws sns：将消息发布到aws sns（亚马逊简单消息通知服务，是一种发布订阅模式的消息收发服务）。 

## 使用特点

组态化拖拽式布局编辑  每个规则节点可以具有取决于规则节点实现的特定配置参数。例如，“过滤器-脚本”规则节点可通过处理传入数据的自定义JS函数进行配置。  

基于调试—事件模式的规则测试  每个规则节点可以设置为调试模式，启用之后，在事件中可以查看到入站-出站消息 

JavaScript 函数测试台  一些规则节点具有特定的UI功能，允许用户测试 JS 函数。单击“ 测试过滤器功能”后，您将看到 JS 编辑器，可使用该编辑器替换输入参数并验证函数的输出。

规则节点可自定义：  如果 [thingsboard](https://www.iotschool.com/topic/26.html) 现有的规则处理节点，无法处理有些定制化业务场景，比如：对于数据进行分类统计，或者分组统计、或者将数据推送到外部 Hadoop 生态去存储、或者将指定一段时间的数据，生成文件导出，推送到远程[服务器](https://www.aliyun.com/minisite/goods?userCode=o1nty5nj)上之类的小场景，可以通过自定义规则节点实现。官方预留扩展开发的接口，很容易构建自己的处理逻辑。

## 代码分析

rule-engine 模块
  * rule-engine-api api 模块
  * rule-engine-components 组件模块

application 模块的 org.thingsboard.server.actors.ruleChain 包进行具体实现。

## 实战

你可以使用ThingsBoard平台将DHT22温度传感器采集的-40°C至+ 80°C温度值进行收集。

在此教程中我们将配置ThingsBoard规则引擎来存储-40至80°C范围内的所有温度，并将所有数据记录到系统日志中。

#### 添加温度并验节点

进入Thingsboard UI中**Rule Chains**转到**Root Rule Chain**.

![](https://upload-images.jianshu.io/upload_images/1662509-0636ebeaa1248fe2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

拖动**Script Filter** 规则节点放入链中并配置如下脚本:

```js
return typeof msg.temperature === 'undefined' 
        || (msg.temperature >= -40 && msg.temperature <= 80);
```

![](https://upload-images.jianshu.io/upload_images/1662509-43387cced55cf247.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

如果未定义温度属性或温度有效则脚本将返回**True**，否则将返回**False**。如果脚本返回**True**则传入消息将被关联到与**True**关系连接的下一个节点。

我们希望所有的**telemetry requests**都通过此脚本进行验证. 删除**Message Type Switch**节点和**Save Telemetry**节点之间的**Post Telemetry**关系节点。

将**Message Type Switch**节点和将**Script Filter**使用**Post Telemetry**进行连接:

![](https://upload-images.jianshu.io/upload_images/1662509-31ffd30069f35afe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


将**Script Filter**节点与**Save Telemetry**节点使用关系**True**进行连接。
将**Script Filter**节点与**Log Other**节点使用关系**False**进行连接这样无效数据将被记录在系统日志中。

![](https://upload-images.jianshu.io/upload_images/1662509-a208556f3094a63a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

点击保存按钮应用更新。

#### 验证结果

创建设备并将遥测提交到Thingsboard，点击**Devices**并创建新的设备：


可以使用设备令牌进行[Rest API](http://www.ithingsboard.com/docs/reference/http-api/#telemetry-upload-api)提交遥测数据提交，

***替换掉$ACCESS_TOKEN为实际设备的Token**

提交temperature = 99的值，可以进行**Latest Telemetry**中查看，发现并未加成功：

```
curl -v -X POST -d '{"temperature":99}' http://localhost:8080/api/v1/$ACCESS_TOKEN/telemetry --header "Content-Type:application/json"
```

![](https://upload-images.jianshu.io/upload_images/1662509-af382c7874ff5124.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

提交temperature = 24可以看见遥测数据保存成功

```
curl -v -X POST -d '{"temperature":24}' http://localhost:8080/api/v1/$ACCESS_TOKEN/telemetry --header "Content-Type:application/json"
```

![](https://upload-images.jianshu.io/upload_images/1662509-53dd74968f160b53.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 模拟实现具体应用场景
