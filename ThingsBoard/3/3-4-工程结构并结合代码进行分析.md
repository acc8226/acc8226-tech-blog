## 项目框架说明

| **包名**    | **包简说明** | **描述**     | **涉及到的技术**      | **备注**   |
| ----------- | ------------ | ------------------- | -------------------------------------- | ------------------ |
| Application | 应用相关  | 新增thingsboard接口，或后端添加业务查询         |                                        | 可修改    |
| Common      | 公共部分     | thingsboard基础方法  |    | 不可修改           |
| Dao         | 业务层       | 接口\实现\数据访问层           | Data-jpa 注解                          | 可修改             |
| Docker      | docker部署   | 打包或虚拟部署    |      | 开发无需修改此包， |
| Img         | 图片         | Logo.png图片          |        | 可添加             |
| Msa         | 分布式       |       |        | 不可修改           |
| Netty-mqtt  | 协议         |            |          | 开发无需修改此包， |
| Rule-engine | 规则引擎     | 规则引擎      |       | 开发无需修改此包， |
| Tools       | 工具类       | 系统工具类     |      | 可修改添加         |
| Transport   | 应用层实现   | 三种请求协议 coap，http mqtt，提供使用(不可修改，可自定义协议，系统提供的三种协议) |        | 不可修改           |
| UI          | 前端界面     | 后台管理系统界面     | Angularjs、ES6、Reactjs、webpack、node | 可修改    |
| Log         | 系统日志     | 系统错误日志收集器，以年月日展示    | Logback  | 不可修改   |

## 社区版（CE版）重要概念

*   **[属性](http://www.ithingsboard.com/docs/user-guide/attributes/)** - 为你的自定义实体分配键值属性（例如配置，数据处理，可视化参数）的平台功能。
*   **[遥测](http://www.ithingsboard.com/docs/user-guide/telemetry/)** - 采集时间序列和相关API用例数据。
*   **[实体和关系](http://www.ithingsboard.com/docs/user-guide/rpc/)** - 创建物理模型对象（例如设备和资产）及它们之间的关系 。
*   **[数据可视化](http://www.ithingsboard.com/docs/guides#AnchorIDDataVisualization)** - 可视化功能: 部件, 仪表板, 仪表板状态。
*   **[规则引擎](http://www.ithingsboard.com/docs/user-guide/rule-engine-2-0/re-getting-started/)** - 对传入的遥测、事件执行相关处理和操作。
*   **[RPC](http://www.ithingsboard.com/docs/user-guide/rpc/)** - 从你的应用程称推送 API 和部件命令至设备，亦可反向推送 。
*   **[审计日志](http://www.ithingsboard.com/docs/user-guide/audit-log/)** - 记录用户行为和API调用情况。
*   **[API 限制](http://www.ithingsboard.com/docs/user-guide/api-limits/)** - 控制在指定时间内主机对 API 的请求情况。
*   **[高级过滤](http://www.ithingsboard.com/docs/user-guide/advanced-filters/)** - 过滤实体字段、属性和最新遥测。

## 功能模块划分

**application**
* appaction.main.java.org.thingsboard.server  ThingsboardServerApplication.java(启动类)
* install			thingsboard服务开启相关配置、异常和调用
* exception		thingsboard响应错误及错误逻辑处理
* controller		thingsboard页面展示必要的 系统数据 接口
* service			为controller提供支持
* config			为同源策略、swagger、webSocket、消息及安全配置注册* spring bean

**dao**

**common**
- actor 规则引擎在幕后使用 Actor 来实现主要实体的 actor：规则链和规则节点。
- util 工具类
- cache 模块
- cluster-api
- queue
- stats
- dao-api
- edge-api：Remote Edge wrapper

**规则引擎** org.thingsboard.rule-engine 共计 2 模块
- rule-engine-api
- rule-engine-components

**transport**  org.thingsboard.common.transport  共计 6 模块
- transport-api 公共 Transport 组件支持
- mqtt 协议支持
- http 协议支持
- coap 协议支持
- lwm2m 协议支持
- snmp 协议支持

### ThingsBoard 微服务架构

![](https://upload-images.jianshu.io/upload_images/1662509-986a843a22585cad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

thingsboard 微服务构架详情：https://thingsboard.io/docs/reference/msa/

![微服务架构图](https://upload-images.jianshu.io/upload_images/1662509-86999252105c814f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### Thingsboard 产品架构

设备接入：MQTT、CoAP、HTTP
规则引擎：配置设备消息的处理流程
核心服务：设备认证、规则和插件、租户和客户、小组件和仪表盘、告警和事件
服务端API网关：REST API、websockets
Actor模型：主要用于并发
集群模式：Zookeeper 用于服务发现，一致性哈希保证消息的扩展性和可用性。
安全：SSL用于 HTTP 和 MQTT
设备认证：Token 和 X.509
第三方工具：AKKA【Actor】、Zookeeper、gRPC、Cassandra

![](https://upload-images.jianshu.io/upload_images/1662509-d8346e97e93dc011.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

### ThingsBoard Architecture

ThingsBoard 旨在跨多个节点分配工作负载，而不会出现单点故障。每个 ThingsBoard 节点都是相同的，可以处理来自设备和服务器端应用程序的请求

描述图

![](https://upload-images.jianshu.io/upload_images/1662509-d55afdb220e22350.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

详情请看：https://thingsboard.io/docs/reference/architecture/

## 系统的关键组件和相关接口 和 整体架构图

![系统的关键组件和相关接口](https://upload-images.jianshu.io/upload_images/1662509-87566c546c311049.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![整体架构图](https://upload-images.jianshu.io/upload_images/1662509-fbb237102d9631ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## 项目框架涉及到的第三方包或插件

**Thingsboard 包**

Redis2.9.0.jar       略*

Snakeyaml.jar         解析yaml

snappy-java.jar          Snappy是[Google](https://www.baidu.com/s?wd=Google&tn=24004469_oem_dg&rsv_dl=gh_pl_sl_csd)开源的压缩/解压缩库

Js-beautify.jar           [Einar Lielmanis](mailto:einar@jsbeautifier.org "mailto:einar@jsbeautifier.org")开发的在线javascript代码格式化工具。Einar在github上开源了这个项目的代码，并加入了格式化html代码的支持。

Testcontainers-1.9.1.jar  Testcontainers是一个 Golang 库，提供一个友好的API来运行Docker容器

Spring-Websocket.jar   浏览器与服务端建立全双工的通信方式，解决 http 请求-响应带来过多的资源消耗，同时对特殊场景应用提供了全新的实现方式，比如聊天、股票交易、游戏等对对实时性要求较高的行业领域。

Spring-webmvc.jar     关于 Spring 相关略.

String-data-jpa.jar     数据库访问层，业务查询sql在thingsboard路径：

thingsboard\thingsboard-release-2.3\dao\src\main\java\org\thingsboard\server\dao\sql

实体类与数据表关联：

thingsboard\thingsboard-release-2.3\dao\src\main\java\org\thingsboard\server\dao\model\sql

Lombok.jar 插件  Lombok 是通过注解的形式帮我们简化 java 代码，在项目中使用比如说getter/setter/toString 等方法的编写，(idea 或 eclipse 需要安装 lombox插件)

Postgresql-9.4.2.jar  Postgresql 数据库对象关系数据库管理系统.

Jbcrypt-0.3m.jar  加解密工具 jBCrypt

详解： java 版 Bcrypt ，加解密工具 (用于账号密码加密，被时间检证过了) ，对用户的口令进行Hash，并使用 salt，以防止 Rainbow 攻击（Hash 算法可用 MD5 或SHA1等，对口令使用salt的意思是，user 在设定密码时，system 产生另外一个random string(salt)。在datbase 存的是与salt + passwd 产的 md5sum 及salt。当要验证密码时就把user 输入的string 加上使用者的salt，产生 md5sum 来比对。理论上用 salt 可以大幅度让密码更难破解，相同的密码除非刚好salt 相同，最后存在database 上的内容是不一样的。使用慢一点的 Hash 算法来保存口令，如 bcrypt (被时间检证过了) 或是 scrypt (更强，但是也更新一些)。

代码：

String password = "testpassword";
String hashed = BCrypt.hashpw(password，BCrypt.gensalt());
System.out.println(hashed);

Json.jar      略*

Hsqldb.jar    (在thingsboard中基本用于thingsboard-demo演示)

HSQLDB 是一款 Java 内置的数据库，非常适合在用于快速的测试和演示的 Java 程序中，

HSQLDB有三种模式：   1\. Server 就像Mysql那样   2\. In-Process 又叫做 Standalone 模式，数据放在本地文件，伴随JVM一起启动，是HSQLDB的主要应用场景   3\. Memory-only， 仅仅在内存中，一旦重启，数据就消失。

Rest-5.0.2.jar  REST 其实是一种组织 Web 服务的架构，而并不是我们想象的那样是实现Web服务的一种新的技术，更没有要求一定要使用 HTTP。其目标是为了创建具有良好扩展性的分布式系统.

Mqttv3-1.1.0.jar  用于开发 mqtt 的客户端使用，方便快速搭建 mqtt 客户端，快速开发实现所需要功能.

jackson-mapper-asl-1.9.13.jar  java对象和 json 相互转化，有 jackson-core-asl、jackson-mapper-asl

ZooKeeper 3.5.4-beta.jar  ZooKeeper 是一个分布式的，开源的分布式应用程序协调服务，是 Google 的 Chubby 一个开源的实现，是 Hadoop 和 Hbase 的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。ZooKeeper 的目标就是封装好复杂易出错的关键服务，将简单易用的接口和性能高效、功能稳定的系统提供给用户。

xmlbeans-2.6.0.jar  XMLBeans 是一个 XML-Java 绑定工具，利用它可以很方便地解析 XML 文档。

Tomcat*.jar     tomcat

Libthrift-0.9.12.jar  thrift 是一个软件框架，用来进行可扩展且跨语言的服务的开发。它结合了功能强大的软件堆栈和代码生成引擎，以构建在 C++， Java， Python， PHP， Ruby， Erlang， Perl， Haskell， C#， Cocoa， JavaScript， Node.js， Smalltalk， and OCaml 这些编程语言间无缝结合的、高效的服务。

Struts*.jar     struts相关包

Poi*.jar      poi相关jar包  如execl、xlsx、pptx、docx 等文件导入导出等操作。

kafka-clients.2.0.0.jar    kafka消息中间件

httpcore-nio-4.4.5.jar     HTTP 协议实现包， 相关 http 包

JOpt Simple 4.6.jar  JOpt Simple 是一个简单的、测试驱动的命令行解析器，支持 POSIX getopt() 和 GNU getopt_long()

json-smart2.0.jar  Json-smart 是一个高性能的JSON处理类库

Log4j-1.2.17.jar     log4j

joda-time-2.3.jar  Joda-Time 提供了一组 Java 类包用于处理包括 ISO8601标准在内的date和time。可以利用它把 JDK Date 和 Calendar 类完全替换掉，而且仍然能够提供很好的集成。

Joda-Time主要的特点包括：

 1\. 易于使用：Calendar 让获取"正常的"的日期变得很困难，使它没办法提供简单的方法，而 Joda-Time 能够 直接进行访问域并且索引值1就是代表 January。

 2\. 易于扩展：JDK支持多日历系统

mailapi-1.4.3.jar 发送邮件相关jar包
javax.annotation-api-1.2.jar
javax.annotation-api-1.2.jar  包，注解，声明，@Resource是做bean的注入使用。 

annotation注解相关jar包略.

*-swagger-*.jar    可以跟据业务代码自动生成相关的api接口文档。
Aopalliane-10.jar

aopalliance.jar  这个包是AOP联盟的API包，里面包含了针对面向切面的接口。aopalliance.jar作用为通常Spring等其它具备动态织入功能的框架依赖此包.

Logback-classic-1.2.3.jar  log4j 项目的后续版本，用于打印 error 系统日志

dom4j-1.6.1.jar  Dom4j是一个Java的XML API接口，是 jdom 的进化版，dom4j基本用来读写[xml文件](http://www.pc6.com/wenjian/xml/)，Hibernate也用它来读写配置文件。

grpc-context-1.12.0.jar  grpc是一个高性能、开源和通用的 RPC 框架，远程调用。

Netty-3.10.5.Final.jar Netty 可自定义通讯协议， 是一个基于 NIO 的客户、服务器端编程框架，使用Netty 可以确保你快速和简单的开发出一个网络应用，例如实现了某种协议的客户，服务端应用。Netty 相当简化和流线化了网络应用的编程开发过程，例如，TCP 和 UDP 的 socket 服务开发。

Akka 用于演员系统实施，[集群-均衡负载](https://www.cnblogs.com/tiger-xc/p/7110661.html)

Cassandra 作为可扩展且可靠的数据库，是一个来自 Apache 的分布式数据库，具有高度可扩展性，可用于管理大量的结构化数据。它提供了高可用性，没有单点故障。

## 依赖的框架、中间件以及环境

**消息队列**：Kafka、RabbitMQ、AWS SQS、Azure 服务总线和 Google 发布订阅。

[Zookeeper](https://zookeeper.apache.org/) 是一种开源服务器，可实现高度可靠的分布式协调。使用 Zookeeper 来处理从单个实体（设备、资产、租户）到特定ThingsBoard 服务器的请求处理，并确保只有一个服务器在单个时间点处理来自特定设备的数据。zk 使用一致性哈希算法确定每个使用者应订阅的分区列表。

**数据库**：PostgreSQL 和 Timescale / Cassandra（NoSQL）**
tb 使用数据库进行存储 [实体](http://www.ithingsboard.com/docs/user-guide/entities-and-relations/)设备，资产，客户，仪表板等）和[遥测](http://www.ithingsboard.com/docs/user-guide/telemetry/)数据（属性，时间序列传感器读数，统计信息，事件）。

建议使用 PostgreSQL 这是 ThingsBoard 支持的主要SQL数据库。 HSQLDB 具有最小的负载可用于本地开发、测试我们不建议将 HSQLDB 用于任何其他用途。

【可选】Redis 用于缓存资产、实体视图、设备、设备凭证、设备会话和实体关系。

【可选】HAProxy。在微服务架构中，建议使用 HAProxy 进行负载均衡。

【可选】[Apache Kafka](https://kafka.apache.org/) 是一个开放源代码的流处理软件平台。使用 Kafka 来保留来自 HTTP/MQTT/CoAP 的传入遥测直到其被规则引擎处理为止。微服务之间进行一些 API 调用。

> 配置：可以使用 **thingsboard.yml** 文件配置此选项。有关更多详细信息，请参见数据库[配置](http://www.ithingsboard.com/docs/user-guide/install/config/)页面。

## tb 工具支持

**thingsboard/ThingsboardSupport**
https://github.com/thingsboard/ThingsboardSupport
* backup&restore 备份和恢复 - 用于数据库备份和恢复(Casandra，Postgres，Postgres + Timescale)
* Log - 用于解析日志以查找队列中的平均和最大消息数
* telemetry 遥测 - 测试向测试设备发送遥测

**thingsboard/flutter_thingsboard_app: ThingsBoard Mobile Application**
https://github.com/thingsboard/flutter_thingsboard_app
tb 的 ce 版 app 客户端，可定制化

**thingsboard/performance-tests: Thingsboard performance tests**
https://github.com/thingsboard/performance-tests
它主要用 Java 编写，并使用 Maven 作为构建工具。Gatling 和 Gatling-MQTT 插件是用 Scala 编写的，并使用 SBT 工具构建源代码和运行测试。
这个项目可以通过从不同设备同时发布大量 MQTT 消息来对 ThingsBoard 服务器进行压力测试。

## 前端 angularjs 迁移到 vue 迁移方案调研

目前 tb 社区版 3.3.4.1 对应 Angular CLI: 12.2.13

2021-04-19 从angularjs 迁移到vue - 简书
https://www.jianshu.com/p/8f6c54af9055

如何从 Angular.js 迁移到 Vue.js - 边城客栈 - OSCHINA - 中文开源技术交流社区
https://my.oschina.net/jamesfancy/blog/4383032

## 代码分析

### cache 模块

**项目 pom 坐标**
```  
<groupId>org.thingsboard.common</groupId>
<artifactId>cache</artifactId>
```

方案，tb 给的方案是 caffeine 或 redis 二选一。默认启用 caffeine 方案，当然也可自己根据需要实现自己的方案。

yml 配置
```yml
cache:
  # caffeine or redis
  type: "${CACHE_TYPE:caffeine}"
```

定义 org.thingsboard.server.cache.ota.OtaPackageDataCache 接口，分别由 org.thingsboard.server.cache.ota.OtaPackageDataCache 和  org.thingsboard.server.cache.ota.RedisOtaPackageDataCache 进行实现。
```
package org.thingsboard.server.cache.ota;

public interface OtaPackageDataCache {

    byte[] get(String key);

    byte[] get(String key, int chunkSize, int chunk);

    void put(String key, byte[] value);

    void evict(String key);

    default boolean has(String otaPackageId) {
        byte[] data = get(otaPackageId, 1, 0);
        return data != null && data.length > 0;
    }
}
```

org.thingsboard.server.cache.CaffeineCacheConfiguration 配置类根据条件进行注入
```java
@Configuration
@ConditionalOnProperty(prefix = "cache", value = "type", havingValue = "caffeine", matchIfMissing = true)
@ConfigurationProperties(prefix = "caffeine")
@EnableCaching
@Data
@Slf4j
public class CaffeineCacheConfiguration {
  ...
}
```

org.thingsboard.server.cache.TBRedisCacheConfiguration 配置类根据条件进行注入
```java
@Configuration
@ConditionalOnProperty(prefix = "cache", value = "type", havingValue = "redis", matchIfMissing = false)
@EnableCaching
@Data
public abstract class TBRedisCacheConfiguration {
  ...
}
```

TBRedisCacheConfiguration 有两个实现：TBRedisStandaloneConfiguration 和 TBRedisClusterConfiguration 分别作为单机和集群版，只需要在 
`thingsboard.yml` 中配置对应字段即可激活。

## 参考项目

chainingning/thingsboard-ui-vue: ThingsBoard 前端开发出 vue 版本
https://github.com/chainingning/thingsboard-ui-vue
